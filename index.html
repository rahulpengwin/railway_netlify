<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Train Wagon Defect Detection - RunPod Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f1f5;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-input-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
        }

        .file-input-label:hover {
            transform: scale(1.05);
        }

        #fileInput {
            display: none;
        }

        .preview-container {
            margin: 20px 0;
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .options-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .option-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .option-card label {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
            cursor: pointer;
        }

        .option-card input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .api-key-section {
            margin: 20px 0;
        }

        .api-key-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: scale(1.02);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .status-IN_QUEUE {
            background: #fff3cd;
            color: #856404;
        }

        .status-IN_PROGRESS {
            background: #cfe2ff;
            color: #084298;
        }

        .status-COMPLETED {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-FAILED {
            background: #f8d7da;
            color: #842029;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-container {
            margin-top: 30px;
            display: none;
        }

        .detection-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .detection-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .severity-critical {
            border-left-color: #dc3545;
        }

        .severity-high {
            border-left-color: #fd7e14;
        }

        .severity-medium {
            border-left-color: #ffc107;
        }

        .severity-low {
            border-left-color: #28a745;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Enhanced Annotated Image Section */
        .annotated-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            border: 3px solid #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
        }

        .annotated-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
        }

        .severity-legend {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .severity-legend h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        .severity-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.95em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .severity-indicator::before {
            content: '‚óè';
            margin-right: 8px;
            font-size: 1.5em;
        }

        .severity-indicator.critical {
            background: #dc3545;
            color: white;
        }

        .severity-indicator.high {
            background: #fd7e14;
            color: white;
        }

        .severity-indicator.medium {
            background: #ffc107;
            color: #333;
        }

        .severity-indicator.low {
            background: #28a745;
            color: white;
        }

        .image-wrapper {
            position: relative;
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .annotated-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 2px solid #667eea;
            display: block;
            margin: 0 auto;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .image-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .download-btn {
            margin-top: 15px;
            padding: 10px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .download-btn:hover {
            transform: scale(1.05);
        }

        .no-image-notice {
            padding: 25px;
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            border-radius: 8px;
            color: #856404;
            margin: 20px 0;
            font-size: 1.05em;
        }

        .error-message {
            background: #f8d7da;
            color: #842029;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #dc3545;
        }

        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #e7f3ff;
            border-left: 3px solid #2196F3;
            border-radius: 5px;
            font-size: 0.85em;
            color: #0c5460;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .options-section {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            .annotated-section {
                padding: 15px;
            }

            .legend-items {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÇ Train Wagon Defect Detection</h1>
        <p class="subtitle">AI-Powered Computer Vision with RunPod Serverless</p>

        <div class="upload-section">
            <div class="file-input-wrapper">
                <label for="fileInput" class="file-input-label">üì∑ Choose Image</label>
                <input type="file" id="fileInput" accept="image/*" />
            </div>
            <div class="preview-container" id="previewContainer">
                <img id="previewImage" class="preview-image" alt="Preview" />
            </div>
        </div>

        <div class="api-key-section">
            <label for="apiKey" style="font-weight: 600; color: #333; margin-bottom: 10px; display: block;">
                üîë RunPod API Key
            </label>
            <input
                type="password"
                id="apiKey"
                class="api-key-input"
                placeholder="Enter your RunPod API Key"
            />
        </div>

        <div class="api-key-section">
            <label for="endpointId" style="font-weight: 600; color: #333; margin-bottom: 10px; display: block;">
                üéØ Endpoint ID
            </label>
            <input
                type="text"
                id="endpointId"
                class="api-key-input"
                placeholder="Enter your RunPod Endpoint ID (e.g., v3usm0g87m12nl)"
                value="v3usm0g87m12nl"
            />
        </div>

        <div class="options-section">
            <div class="option-card">
                <label>
                    <input type="checkbox" id="enhancedAccuracy" checked />
                    Enhanced Accuracy Mode
                </label>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    Multi-stage filtering with >95% accuracy
                </p>
            </div>
            <div class="option-card">
                <label>
                    <input type="checkbox" id="highPrecision" checked />
                    High Precision Detection
                </label>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    Advanced confidence refinement
                </p>
            </div>
        </div>

        <button class="submit-btn" id="submitBtn" disabled>üöÄ Detect Defects</button>

        <div class="status-container" id="statusContainer">
            <h3>üìä Processing Status</h3>
            <div id="statusContent"></div>
        </div>

        <div class="results-container" id="resultsContainer">
            <h2 style="color: #333; margin-bottom: 20px;">üéØ Detection Results</h2>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        const RUNPOD_API_BASE = 'https://api.runpod.ai/v2';
        const POLL_INTERVAL = 2000;
        const DEBUG_MODE = true;

        let selectedFile = null;
        let optimizedFile = null; // Store the resized/compressed file here
        let jobId = null;
        let pollInterval = null;
        let annotatedImageData = null;

        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const apiKeyInput = document.getElementById('apiKey');
        const endpointIdInput = document.getElementById('endpointId');
        const submitBtn = document.getElementById('submitBtn');
        const statusContainer = document.getElementById('statusContainer');
        const statusContent = document.getElementById('statusContent');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsContent = document.getElementById('resultsContent');

        function debugLog(message, data = null) {
            if (DEBUG_MODE) {
                console.log(`[DEBUG] ${message}`, data || '');
            }
        }

        fileInput.addEventListener('change', handleFileSelect);
        apiKeyInput.addEventListener('input', validateForm);
        endpointIdInput.addEventListener('input', validateForm);
        submitBtn.addEventListener('click', handleSubmit);

        // Resize and compress the image file
        function resizeImage(file, maxWidth = 1024, maxHeight = 1024, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const image = new Image();
                const reader = new FileReader();

                reader.onload = function (e) {
                    image.src = e.target.result;
                };

                image.onload = function () {
                    let width = image.width;
                    let height = image.height;

                    // Calculate new dimensions while maintaining aspect ratio
                    if (width > maxWidth || height > maxHeight) {
                        if (width / height > maxWidth / maxHeight) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        } else {
                            width = Math.round((width * maxHeight) / height);
                            height = maxHeight;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');

                    ctx.drawImage(image, 0, 0, width, height);

                    // Convert canvas back to Blob (JPEG), adjust quality if needed
                    canvas.toBlob(
                        (blob) => {
                            if (blob) {
                                resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                            } else {
                                reject(new Error('Image compression failed.'));
                            }
                        },
                        'image/jpeg',
                        quality
                    );
                };

                image.onerror = () => reject(new Error('Failed to load image for resizing'));
                reader.onerror = () => reject(new Error('Failed to read file'));

                reader.readAsDataURL(file);
            });
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                debugLog('File selected:', file.name);

                // Resize/compress the image and store optimized file
                try {
                    optimizedFile = await resizeImage(file, 1024, 1024, 0.7);
                    debugLog('Image optimized:', optimizedFile);

                    // Show preview of optimized image
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(optimizedFile);

                    validateForm();
                } catch (error) {
                    console.error('Image optimization error:', error);
                    // Fallback: show original image if optimization fails
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);

                    optimizedFile = file;
                    validateForm();
                }
            }
        }

        function validateForm() {
            const hasFile = optimizedFile !== null;
            const hasApiKey = apiKeyInput.value.trim().length > 0;
            const hasEndpointId = endpointIdInput.value.trim().length > 0;

            submitBtn.disabled = !(hasFile && hasApiKey && hasEndpointId);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove data URL prefix
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        function downloadAnnotatedImage() {
            if (!annotatedImageData) {
                alert('No annotated image available to download');
                return;
            }

            const link = document.createElement('a');
            link.href = annotatedImageData;
            link.download = `defect_detection_${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            debugLog('Annotated image downloaded');
        }

        async function handleSubmit() {
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Processing...';

                resultsContainer.style.display = 'none';
                statusContainer.style.display = 'block';
                statusContent.innerHTML = '<div class="spinner"></div><p>Converting image...</p>';

                // Use optimizedFile instead of selectedFile
                const base64Image = await fileToBase64(optimizedFile);
                debugLog('Image converted to base64, length:', base64Image.length);

                const apiKey = apiKeyInput.value.trim();
                const endpointId = endpointIdInput.value.trim();
                const enhancedAccuracy = document.getElementById('enhancedAccuracy').checked;
                const highPrecision = document.getElementById('highPrecision').checked;

                const payload = {
                    input: {
                        file: base64Image,
                        filename: optimizedFile.name,
                        enhanced_accuracy: enhancedAccuracy,
                        high_precision: highPrecision,
                        save_results: true,
                    },
                };

                debugLog('Payload prepared:', {
                    filename: optimizedFile.name,
                    enhanced_accuracy: enhancedAccuracy,
                    high_precision: highPrecision,
                });

                statusContent.innerHTML = '<div class="spinner"></div><p>Submitting job to RunPod...</p>';

                const runResponse = await fetch(`${RUNPOD_API_BASE}/${endpointId}/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${apiKey}`,
                    },
                    body: JSON.stringify(payload),
                });

                const runData = await runResponse.json();
                debugLog('RunPod response:', runData);

                if (!runResponse.ok) {
                    throw new Error(runData.error || 'Failed to submit job');
                }

                jobId = runData.id;

                statusContent.innerHTML = `
                    <div class="spinner"></div>
                    <p><strong>Job ID:</strong> ${jobId}</p>
                    <p><span class="status-badge status-IN_QUEUE">IN_QUEUE</span></p>
                    <p>Your job is in the queue. Waiting for worker...</p>
                `;

                pollJobStatus(apiKey, endpointId, jobId);
            } catch (error) {
                console.error('Error:', error);
                statusContent.innerHTML = `
                    <div class="error-message">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Detect Defects';
            }
        }

        async function pollJobStatus(apiKey, endpointId, jobId) {
            pollInterval = setInterval(async () => {
                try {
                    const statusResponse = await fetch(
                        `${RUNPOD_API_BASE}/${endpointId}/status/${jobId}`,
                        {
                            headers: {
                                Authorization: `Bearer ${apiKey}`,
                            },
                        }
                    );

                    const statusData = await statusResponse.json();
                    debugLog('Status update:', statusData);

                    updateStatusDisplay(statusData);

                    if (statusData.status === 'COMPLETED') {
                        clearInterval(pollInterval);
                        displayResults(statusData);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'üöÄ Detect Defects';
                    } else if (statusData.status === 'FAILED') {
                        clearInterval(pollInterval);
                        statusContent.innerHTML = `
                            <div class="error-message">
                                <strong>‚ùå Job Failed:</strong> ${statusData.error || 'Unknown error'}
                            </div>
                        `;
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'üöÄ Detect Defects';
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    clearInterval(pollInterval);
                    statusContent.innerHTML = `
                        <div class="error-message">
                            <strong>‚ùå Polling Error:</strong> ${error.message}
                        </div>
                    `;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üöÄ Detect Defects';
                }
            }, POLL_INTERVAL);
        }

        function updateStatusDisplay(statusData) {
            const status = statusData.status;
            let statusMessage = '';

            switch (status) {
                case 'IN_QUEUE':
                    statusMessage = 'Your job is waiting in the queue...';
                    break;
                case 'IN_PROGRESS':
                    statusMessage = 'Processing image with YOLOv11 model...';
                    break;
                case 'COMPLETED':
                    statusMessage = 'Detection completed successfully!';
                    break;
                case 'FAILED':
                    statusMessage = 'Job failed. Please try again.';
                    break;
                default:
                    statusMessage = `Status: ${status}`;
            }

            statusContent.innerHTML = `
                ${status !== 'COMPLETED' ? '<div class="spinner"></div>' : ''}
                <p><strong>Job ID:</strong> ${statusData.id}</p>
                <p><span class="status-badge status-${status}">${status}</span></p>
                <p>${statusMessage}</p>
                ${
                    statusData.delayTime
                        ? `<p><small>Queue delay: ${(statusData.delayTime / 1000).toFixed(2)}s</small></p>`
                        : ''
                }
                ${
                    statusData.executionTime
                        ? `<p><small>Execution time: ${(statusData.executionTime / 1000).toFixed(2)}s</small></p>`
                        : ''
                }
            `;
        }

        function displayResults(data) {
            const output = data.output;

            debugLog('Display results called with output:', output);

            if (!output || output.error) {
                resultsContent.innerHTML = `
                    <div class="error-message">
                        <strong>‚ùå Error:</strong> ${output?.error || 'No output received'}
                    </div>
                `;
                resultsContainer.style.display = 'block';
                return;
            }

            let metricsHTML = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${output.detections_count || 0}</div>
                        <div class="metric-label">Total Defects</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${output.processing_time}s</div>
                        <div class="metric-label">Processing Time</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${output.severity_breakdown?.critical || 0}</div>
                        <div class="metric-label">Critical</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${output.severity_breakdown?.high || 0}</div>
                        <div class="metric-label">High Severity</div>
                    </div>
                </div>
            `;

            let annotatedImageHTML = '';
            if (output.annotated_image) {
                annotatedImageData = output.annotated_image;

                debugLog('Annotated image found, base64 length:', output.annotated_image.length);
                debugLog('Image data prefix:', output.annotated_image.substring(0, 50));

                annotatedImageHTML = `
                    <div class="annotated-section">
                        <h3>üì∏ Defect Detection Results</h3>
                        <div class="severity-legend">
                            <h4>üé® Severity Color Legend</h4>
                            <div class="legend-items">
                                <span class="severity-indicator critical">Critical</span>
                                <span class="severity-indicator high">High</span>
                                <span class="severity-indicator medium">Medium</span>
                                <span class="severity-indicator low">Low</span>
                            </div>
                            <p style="margin-top: 15px; font-size: 0.95em; color: #666; text-align: center;">
                                Defects are marked with colored bounding boxes and labels showing type and confidence level
                            </p>
                        </div>
                        <div class="image-wrapper">
                            <img src="${output.annotated_image}"
                                class="annotated-image"
                                alt="Train Wagon with Detected Defects"
                                onerror="console.error('Failed to load annotated image'); this.style.display='none';"
                                onload="console.log('Annotated image loaded successfully');">
                            <div class="image-info">
                                üìä Image shows ${output.detections_count || 0} detected defect${output.detections_count !== 1 ? 's' : ''}
                                with bounding boxes and confidence scores
                            </div>
                            <button class="download-btn" onclick="downloadAnnotatedImage()">
                                ‚¨áÔ∏è Download Annotated Image
                            </button>
                        </div>
                        ${
                            DEBUG_MODE
                                ? `<div class="debug-info">
                                    Debug Info:<br>
                                    - Base64 data length: ${output.annotated_image.length} characters<br>
                                    - Data URI format: ${output.annotated_image.startsWith('data:image') ? 'Valid' : 'Invalid'}<br>
                                    - Image type: ${output.annotated_image.substring(5, 15)}
                                </div>`
                                : ''
                        }
                    </div>
                `;
            } else {
                debugLog('No annotated image in response');
                annotatedImageHTML = `
                    <div class="no-image-notice">
                        <strong>‚ö†Ô∏è Notice:</strong> Annotated image not available in the response.
                        This might indicate an issue with the backend processing or image encoding.
                        ${
                            DEBUG_MODE
                                ? `<br><br>Debug: Check if 'annotated_image' field exists in output: ${Object.keys(output).join(', ')}`
                                : ''
                        }
                    </div>
                `;
            }

            let detectionsHTML = '<h3 style="margin-top: 30px;">üîç Detected Defects Details</h3>';

            if (output.detections && output.detections.length > 0) {
                output.detections.forEach((detection, index) => {
                    detectionsHTML += `
                        <div class="detection-card severity-${detection.severity}">
                            <h3>${index + 1}. ${detection.defect_type}</h3>
                            <p><strong>Severity:</strong> ${detection.severity.toUpperCase()}</p>
                            <p><strong>Confidence:</strong> ${(detection.confidence * 100).toFixed(2)}%</p>
                            ${
                                detection.recommendations
                                    ? `<p><strong>Recommendations:</strong> ${detection.recommendations}</p>`
                                    : ''
                            }
                        </div>
                    `;
                });
            } else {
                detectionsHTML += '<p style="color: #28a745; font-weight: bold; padding: 20px; background: #d1e7dd; border-radius: 10px;">‚úÖ No defects detected! Wagon is in good condition.</p>';
            }

            resultsContent.innerHTML = metricsHTML + annotatedImageHTML + detectionsHTML;
            resultsContainer.style.display = 'block';

            setTimeout(() => {
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    </script>
</body>
</html>
